<!DOCTYPE html>
<html>
<head>
  <title>UCD ForSec DeepLearning Helper</title>
  <script LANGUAGE="JavaScript" type="text/javascript">
    var count = 0;
    var lastvote;
    var previmagekey;
    var imagekey;
    function GetAsync(){
        fetch('http://'+ location.hostname + '/api/getkey/').then(function(response) {
            response.text().then(function(text) {
                imagekey = text;
                document.getElementById("imagedisplay").src = text;
                });
            });
    }
    function GetLastpic(){
        imagekey = previmagekey;
        previmagekey = "";
        document.getElementById("imagedisplay").src = imagekey;
    }
    function vote(url,boolVote){
        count +=1;
        return _vote(url,boolVote,"/api/vote/")
    }
    function unvote(url,boolVote){
        count -=1;
        return _vote(url,boolVote,"/api/unvote/")
    }
    function _vote(url,boolVote,path){ 
        voteObj = {"key": imagekey, "vote": boolVote};
        console.log(JSON.stringify(voteObj))
        fetch(url + path, {
        method: "POST",
        headers: {
            'Accept': 'application/json, text/plain, */*',
            'Content-Type': 'application/json; charset=UTF-8'
        },
        body: JSON.stringify(voteObj),
    }).then(function(response) {
            response.text().then(function(text) {
                console.log(text);
                });
            });
        document.getElementById("counter").innerHTML = "<strong>" + count.toString() + "</strong>";
    }
    function sleep(milliseconds) {
        var start = new Date().getTime();
        for (var i = 0; i < 1e7; i++) {
            if ((new Date().getTime() - start) > milliseconds){
            break;
            }
        }
    }
    function voteAndFetch(boolVote){
        vote('http://'+ location.hostname, boolVote);
        lastvote = boolVote;
        previmagekey = imagekey;
        sleep(50);
        GetAsync();
        sleep(100);
        return;
    }
    function undoVote(){
        GetLastpic();
        unvote('http://'+ location.hostname, lastvote);
    }
    </script>
</head>
<body onload="GetAsync()">
    <div id="page" class="container">
        <div class="navbar row" style="color: #7b818c; background-color:#7b818c">
            <div>
                <img src="./media/forseclogo.png" style="width: 12.5em; margin: 5px; margin-left: 20px" alt="UCD Forensics and Security Research Group Logo">
                <!-- <h1>UCD ForSec Group</h1> -->
            </div>
            <div>
                <p><font color="white">Help us cassify Hotel Room pictures. If the picture shown is or not a photo of a Hotel Room.</font></p>
                <p><font color="white">Instructions: Slide, Use the Keyboard Keys, or Click the buttons.</font></p>
            </div>
                
        </div>
        <br>
        <div class="container">
            <div class="row">
                <div class="col-sm-1 col-md-2 text-align text-center"><h1><button class="btn-danger" on-hold="voteAndFetch('false');" on-tap="voteAndFetch('false');" on-tap="voteAndFetch('false');" on-touch="voteAndFetch('false');" onclick="voteAndFetch('false');" >&#8592;</button></h1><h1>&#215;</h1><h2 class="text-align text-center">NOT A ROOM</h2></div>
                <div class="col-sm-10 col-md-8"><img class="text-align text-center" id="imagedisplay" style="text-align: center" src="" alt=""></div>
                <div class="col-sm-1 col-md-2 text-align text-center"><h1><button class="btn-success" on-hold="voteAndFetch('true');" on-tap="voteAndFetch('true');" on-tap="voteAndFetch('true');" on-touch="voteAndFetch('true');" onclick="voteAndFetch('true');">&#8594;</button></h1><h1>&#10003;</h1><h2 class="text-align text-center">IS A ROOM</h2></div>
            </div>
        </div>
        <br>
        <div class="row">
            <div class="col-sm-12 col-md-12 text-center"><h1><button class="btn-danger text-align text-center" on-hold="undoVote();" on-tap="undoVote();" on-tap="undoVote();" on-touch="undoVote();" onclick="undoVote();">&#x21ba;</button></h1><h2 class="text-align text-center">UNDO LAST VOTE</h2> <h3>Shortcut: U</h3></div>
        </div>
        <br>
        <br>
        <footer class="page-footer font-small blue fixed-bottom" >
            <div class="footer-copyright text-center py-3" style="color: #7b818c; background-color:#7b818c" >
                <font color="white">You calssified</font> <font color="lime" id="counter">0</font>
                <font color="white"> images. &nbsp;&nbsp; Thank you for your help.</font>
        </div>
        </footer>
    </div>
<style>
    .container img {
        width: 100%;
    }
</style>
<script>
    function swipedetect(el, callback){
        var touchsurface = el,
        swipedir,
        startX,
        startY,
        distX,
        distY,
        threshold = 150, //required min distance traveled to be considered swipe
        restraint = 100, // maximum distance allowed at the same time in perpendicular direction
        allowedTime = 300, // maximum time allowed to travel that distance
        elapsedTime,
        startTime,
        handleswipe = callback || function(swipedir){}

        touchsurface.addEventListener('touchstart', function(e){
            var touchobj = e.changedTouches[0]
            swipedir = 'none'
            dist = 0
            startX = touchobj.pageX
            startY = touchobj.pageY
            startTime = new Date().getTime() // record time when finger first makes contact with surface
            e.preventDefault()
        }, false)

        touchsurface.addEventListener('touchmove', function(e){
            e.preventDefault() // prevent scrolling when inside DIV
        }, false)

        touchsurface.addEventListener('touchend', function(e){
            var touchobj = e.changedTouches[0]
            distX = touchobj.pageX - startX // get horizontal dist traveled by finger while in contact with surface
            distY = touchobj.pageY - startY // get vertical dist traveled by finger while in contact with surface
            elapsedTime = new Date().getTime() - startTime // get time elapsed
            if (elapsedTime <= allowedTime){ // first condition for awipe met
                if (Math.abs(distX) >= threshold && Math.abs(distY) <= restraint){ // 2nd condition for horizontal swipe met
                    swipedir = (distX < 0)? 'left' : 'right' // if dist traveled is negative, it indicates left swipe
                }
                else if (Math.abs(distY) >= threshold && Math.abs(distX) <= restraint){ // 2nd condition for vertical swipe met
                    swipedir = (distY < 0)? 'up' : 'down' // if dist traveled is negative, it indicates up swipe
                }
            }
            handleswipe(swipedir)
            e.preventDefault()
        }, false)
    }  

window.addEventListener('load', function(){
    var el = document.getElementById('page')
    var inner = document.getElementById('page')
    var hidetimer = null
    swipedetect(el, function(swipedir){
        if (swipedir == 'left'){
            clearTimeout(hidetimer);
            voteAndFetch("true");
        } else if (swipedir == 'right'){
            clearTimeout(hidetimer);
            voteAndFetch("false");
        }
    })
}, false)

document.addEventListener("keydown", function(event) {
    if(event.keyCode == 37){
        console.log(event.which);
        voteAndFetch("false");
        return ;
    }
    if(event.keyCode == 39){
        console.log(event.which);
        voteAndFetch("true");
                return ;
    }
    if(event.keyCode == 85){
        console.log(event.which);
        undoVote();
                return ;
    }
    return ;
})
</script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/js/bootstrap.min.js" integrity="sha384-o+RDsa0aLu++PJvFqy8fFScvbHFLtbvScb8AjopnFD+iEQ7wo/CG0xlczd+2O/em" crossorigin="anonymous"></script>
</html>